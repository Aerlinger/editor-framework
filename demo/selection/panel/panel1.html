<style>
    selection-demo-panel1 svg rect.node {
        fill: #09f;
        stroke-width: 2;
        stroke: #fff;
        cursor: pointer;
    }

    selection-demo-panel1 svg .rect-select {
        fill: rgba( 0, 128, 255, 0.4 );
        stroke-width: 1;
        stroke: #09f;
    }
</style>

<dom-module id="selection-demo-panel1">
    <style>
        :host {
            display: flex;
            flex-wrap: nowrap;
            align-items: stretch;
            flex-direction: column;
        }
        ul {
            margin: 0px;
            padding: 5px;
        }
        ul li {
            cursor: pointer;
            padding: 5px;
            margin: 1px;
            list-style-type: none;
        }
        ul li:hover {
            background: #555;
        }
        ul li[selected] {
            background: #09f;
        }
        svg {
            border: 1px solid black;
            background: #333;
            shape-rendering: crispEdges;
        }
    </style>

    <template>
        <div class="layout vertical fit">
            <ul class="flex-1">
                <template is="dom-repeat" items="{{list}}">
                    <li on-click="_onSelect" selected$="{{item.selected}}"><span>{{item.name}}</span></li>
                </template>
            </ul>
            <svg id="svg" class="flex-1"
                on-mousedown="_onMouseDown"
                ></svg>
        </div>
    </template>
</dom-module>

<script type="text/javascript" src="app://bower_components/svg.js/dist/svg.min.js"></script>
<script>
Editor.registerPanel( 'selection-demo.panel1', {
    is: 'selection-demo-panel1',

    ready: function () {
        this.list = [
            { name: 'extrajudicially', selected: false },
            { name: 'duse',  selected: false },
            { name: 'appleton', selected: false },
            { name: 'aborning', selected: false },
            { name: 'evacuee', selected: false },
            { name: 'impecunious', selected: false },
            { name: 'overrude', selected: false },
            { name: 'subrange', selected: false },
            { name: 'hamlet', selected: false },
            { name: 'subtranslucency', selected: false },
        ];
    },

    attached: function () {
        EditorUI.update( this, 'list' );
        this.async(function() {
            this.lightDomReady();
        });
    },

    lightDomReady: function () {
        this.svg = SVG(this.$.svg);
        this.scene = this.svg.group();
        this.foreground = this.svg.group();

        var rect = this.$.svg.getBoundingClientRect();
        for ( var i = 0; i < this.list.length; ++i ) {
            var name = this.list[i].name;

            var x = Math.randomRange( 20, rect.width-20 );
            var y = Math.randomRange( 20, rect.height-20 );
            var node = this.scene.group();
            var rectNode = node.rect( 10, 10 )
                .move( -5, 0 )
                // .stroke({ width: 2, color: '#fff' } )
                // .fill({ color: '#09f' } )
                .translate( x, y )
                .addClass('node')
                ;
            rectNode.selectable = true;
            rectNode.name = name;

            node.plain(name)
                .font({
                    size: 15,
                    anchor: 'middle',
                })
                .fill({ color: '#999' } )
                .translate( x, y - 5 )
                ;
        }

        this.selectRect = this.foreground.rect();
        this.selectRect.addClass('rect-select');
        this.selectRect.hide();
    },

    _onSelect: function ( event ) {
        var model = event.model;
        // model.set( 'item.selected', !model.item.selected );
        Editor.Selection.select( 'normal', model.item.name, true, true );
    },

    _onMouseDown: function ( event ) {
        if ( event.which === 1 ) {
            event.stopPropagation();

            var rect = this.$.svg.getBoundingClientRect();
            var pressx = event.clientX;
            var pressy = event.clientY;

            var mousemoveHandle = function(event) {
                event.stopPropagation();

                var startx = pressx - rect.left;
                var starty = pressy - rect.top;
                var offsetx = event.clientX - pressx;
                var offsety = event.clientY - pressy;

                var magSqr = offsetx*offsetx + offsety*offsety;
                if ( magSqr < 2.0 * 2.0 ) {
                    return;
                }

                if ( offsetx < 0.0 ) {
                    startx += offsetx;
                    offsetx = -offsetx;
                }
                if ( offsety < 0.0 ) {
                    starty += offsety;
                    offsety = -offsety;
                }

                this.selectRect
                    .show()
                    .move( startx, starty )
                    .size( offsetx, offsety )
                    ;
                var results = this.rectHitTest( startx, starty, offsetx, offsety );
                Editor.Selection.select ( 'normal', results, true, false );
            }.bind(this);

            var mouseupHandle = function(event) {
                event.stopPropagation();

                document.removeEventListener('mousemove', mousemoveHandle);
                document.removeEventListener('mouseup', mouseupHandle);

                EditorUI.removeDragGhost();
                this.style.cursor = '';

                this.selectRect.hide();
            }.bind(this);

            //
            EditorUI.addDragGhost();
            document.addEventListener ( 'mousemove', mousemoveHandle );
            document.addEventListener ( 'mouseup', mouseupHandle );

            return;
        }
    },

    'selection:changed': function ( type ) {
        var selection = Editor.Selection.selecting(type);
        for ( var i = 0; i < this.list.length; ++i ) {
            var item = this.list[i];
            this.set('list.' + i + '.selected', selection.indexOf(item.name) !== -1 );
        }
    },

    rectHitTest: function ( x, y, w, h ) {
        var rect = this.svg.node.createSVGRect();
        rect.x = x;
        rect.y = y;
        rect.width = w;
        rect.height = h;

        var els = this.svg.node.getIntersectionList(rect, null);
        var results = [];

        for ( var i = 0; i < els.length; ++i ) {
            var el = els[i];
            var node = SVG.get(el.id);
            if ( node.selectable ) {
                results.push( node.name );
            }
        }

        return results;
    },
});
</script>
